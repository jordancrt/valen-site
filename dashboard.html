<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/style.css" />
  <title>ValenHub — Tableau</title>
  <style>
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{border:1px solid rgba(255,255,255,.12);padding:8px;font-size:14px}
    .right{text-align:right}
    .muted{opacity:.85}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .pill{padding:6px 10px;border:1px solid rgba(255,255,255,.2);border-radius:999px}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="brand"><div class="logo"></div><h1>VALENHUB</h1></div>
    <div class="links">
      <a href="/">Accueil</a>
      <a href="dashboard.html" class="btn">Tableau</a>
      <a href="chat.html">Chat IA</a>
      <a href="about.html">À propos</a>
    </div>
  </nav>

  <section class="container">
    <h2>Budget & tâches (local)</h2>
    <p class="muted">Vos données restent <b>sur votre appareil</b> (localStorage). Vous pouvez les exporter en JSON.</p>

    <!-- Formulaire d'ajout -->
    <div class="grid two" style="margin-top:16px">
      <div>
        <h3>Ajouter un élément</h3>
        <div class="grid">
          <label>Type
            <select id="type">
              <option value="dépense">Dépense</option>
              <option value="revenu">Revenu</option>
              <option value="tâche">Tâche</option>
            </select>
          </label>
          <label>Catégorie
            <input id="cat" placeholder="ex: courses / loyer / salaire / à faire">
          </label>
          <label>Montant (€) <small class="muted">(vide si tâche)</small>
            <input id="amt" type="number" step="0.01" placeholder="ex: 45.90">
          </label>
          <label>Date
            <input id="date" type="date">
          </label>
          <label>Note
            <input id="note" placeholder="optionnel">
          </label>
          <button class="btn" id="addBtn">Ajouter</button>
        </div>
      </div>

      <div>
        <h3>Objectif du mois</h3>
        <div class="grid">
          <label>Budget mensuel (€)
            <input id="goal" type="number" step="1" placeholder="ex: 1200">
          </label>
          <button class="btn-secondary" id="saveGoal">Enregistrer l’objectif</button>
          <div class="pill" id="goalInfo">Aucun objectif pour l’instant.</div>
        </div>

        <h3 style="margin-top:18px">Résumé</h3>
        <div class="grid two">
          <div class="pill">Revenus: <b id="sumIn">0</b> €</div>
          <div class="pill">Dépenses: <b id="sumOut">0</b> €</div>
          <div class="pill">Solde du mois: <b id="net">0</b> €</div>
          <div class="pill">Reste vs objectif: <b id="left">—</b></div>
        </div>

        <div class="controls">
          <button id="exportBtn" class="btn-small">Exporter JSON</button>
          <input id="importInput" type="file" accept="application/json" style="display:none">
          <button id="importBtn" class="btn-small">Importer JSON</button>
          <button id="clearBtn" class="btn-small">Tout effacer</button>
        </div>
      </div>
    </div>

    <!-- Tableau -->
    <h3 style="margin-top:12px">Historique</h3>
    <table class="table" id="tbl">
      <thead>
        <tr><th>Date</th><th>Type</th><th>Catégorie / Tâche</th><th class="right">Montant</th><th>Note</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <footer class="footer">© <span id="y"></span> ValenHub</footer>

  <script>
    const KEY='valen_items_v1';  // enregistrements
    const GKEY='valen_goal_v1';  // objectif
    const $=s=>document.querySelector(s);
    const $$=s=>document.querySelectorAll(s);
    const ls = {
      get(k, d){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    const state = {
      items: ls.get(KEY, []),
      goal: ls.get(GKEY, null)
    };

    const ui = {
      tbody: $('#tbl tbody'),
      sumIn: $('#sumIn'), sumOut: $('#sumOut'), net: $('#net'), left: $('#left'),
      goalInfo: $('#goalInfo')
    };

    function render(){
      // tri par date desc
      state.items.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      ui.tbody.innerHTML = state.items.map((x,i)=> `
        <tr>
          <td>${x.date||''}</td>
          <td>${x.type}</td>
          <td>${x.cat||x.note||''}</td>
          <td class="right">${x.type==='tâche' ? '—' : (Number(x.amt||0).toFixed(2)+' €')}</td>
          <td>${x.note||''}</td>
          <td><button class="btn-small" data-del="${i}">Suppr.</button></td>
        </tr>`).join('');

      // sommes mensuelles (mois courant)
      const m = new Date().toISOString().slice(0,7); // AAAA-MM
      const cur = state.items.filter(x => (x.date||'').startsWith(m));
      const inc = cur.filter(x=>x.type==='revenu').reduce((s,x)=> s+Number(x.amt||0),0);
      const exp = cur.filter(x=>x.type==='dépense').reduce((s,x)=> s+Number(x.amt||0),0);
      ui.sumIn.textContent = inc.toFixed(2);
      ui.sumOut.textContent = exp.toFixed(2);
      ui.net.textContent = (inc-exp).toFixed(2);

      if(state.goal){
        const left = state.goal - exp;
        ui.left.textContent = `${left.toFixed(2)} € (objectif: ${state.goal} €)`;
        ui.goalInfo.textContent = `Objectif mensuel: ${state.goal} €`;
      } else {
        ui.left.textContent = '—';
        ui.goalInfo.textContent = 'Aucun objectif pour l’instant.';
      }
    }

    $('#addBtn').onclick = ()=>{
      const type=$('#type').value;
      const cat=$('#cat').value.trim();
      const amt=$('#amt').value;
      const date=$('#date').value || new Date().toISOString().slice(0,10);
      const note=$('#note').value.trim();
      if(type!=='tâche' && (amt==='' || Number.isNaN(Number(amt)))) return alert('Montant invalide');
      state.items.push({type, cat, amt, date, note});
      ls.set(KEY, state.items);
      $('#cat').value=''; $('#amt').value=''; $('#note').value='';
      render();
    };

    $('#saveGoal').onclick = ()=>{
      const g = Number($('#goal').value);
      if(Number.isNaN(g) || g<=0) return alert('Entrez un montant valide');
      state.goal = g; ls.set(GKEY, g); render();
    };

    $('#exportBtn').onclick = ()=>{
      const data = { items: state.items, goal: state.goal };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'valenhub-data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    };
    $('#importBtn').onclick = ()=> $('#importInput').click();
    $('#importInput').onchange = e=>{
      const file = e.target.files[0]; if(!file) return;
      const r = new FileReader();
      r.onload = ()=> {
        try{
          const data = JSON.parse(r.result);
          state.items = data.items || [];
          state.goal = data.goal || null;
          ls.set(KEY, state.items); ls.set(GKEY, state.goal);
          render();
        }catch{ alert('Fichier invalide'); }
      };
      r.readAsText(file);
    };
    $('#clearBtn').onclick = ()=>{
      if(confirm('Tout effacer ?')) { state.items=[]; state.goal=null; ls.set(KEY,[]); ls.set(GKEY,null); render(); }
    };

    document.addEventListener('click', e=>{
      const i = e.target.dataset.del;
      if(i!==undefined){ state.items.splice(Number(i),1); ls.set(KEY,state.items); render(); }
    });

    document.getElementById('y').textContent = new Date().getFullYear();
    render();
  </script>
</body>
</html>
